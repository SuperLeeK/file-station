# FileStation (webhard) í”„ë¡œì íŠ¸ ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ

**ë¶„ì„ ëŒ€ìƒ**: FileStation ì›¹í•˜ë“œ ì‹œìŠ¤í…œ  
**ì´ ì½”ë“œ ë¼ì¸**: ì•½ 18,880ì¤„ (ì£¼ìš” íŒŒì¼ ê¸°ì¤€)  
**ë¶„ì„ ì¼ì**: 2026-01-20

---

## ğŸ“ 1. í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

### 1.1 íŒŒì¼ êµ¬ì„±
```
webhard/
â”œâ”€â”€ api.php (2,322ì¤„) - REST API ë¼ìš°í„°
â”œâ”€â”€ config.php - ì „ì—­ ì„¤ì •
â”œâ”€â”€ index.php (1,950ì¤„) - ë©”ì¸ UI
â”œâ”€â”€ share.php - ê³µìœ  ë§í¬ í˜ì´ì§€
â”œâ”€â”€ mydav.php - WebDAV ì§„ì…ì 
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ Auth.php (1,009ì¤„) - ì¸ì¦/ì„¸ì…˜ ê´€ë¦¬
â”‚   â”œâ”€â”€ FileManager.php (2,094ì¤„) - íŒŒì¼ CRUD
â”‚   â”œâ”€â”€ Storage.php (983ì¤„) - ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
â”‚   â”œâ”€â”€ ShareManager.php (464ì¤„) - ê³µìœ  ë§í¬
â”‚   â”œâ”€â”€ FileIndex.php (514ì¤„) - SQLite ê²€ìƒ‰ ì¸ë±ìŠ¤
â”‚   â”œâ”€â”€ JsonDB.php (315ì¤„) - JSON íŒŒì¼ DB
â”‚   â”œâ”€â”€ WebDAV.php (780ì¤„) - WebDAV ì„œë²„
â”‚   â”œâ”€â”€ ActivityLog.php (219ì¤„) - í™œë™ ë¡œê·¸
â”‚   â”œâ”€â”€ StorageAdapter.php (828ì¤„) - ì›ê²© ìŠ¤í† ë¦¬ì§€ (ë¯¸ì‚¬ìš©)
â”‚   â””â”€â”€ DebugLog.php (102ì¤„) - ë””ë²„ê·¸ ë¡œê¹…
â””â”€â”€ assets/
    â”œâ”€â”€ js/app.js (7,300ì¤„) - í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§
    â””â”€â”€ css/style.css - ìŠ¤íƒ€ì¼ì‹œíŠ¸
```

### 1.2 ì—­í•  ë¶„ë¦¬ ìƒíƒœ
| íŒŒì¼ | ì—­í•  | í‰ê°€ |
|------|------|------|
| api.php | API ë¼ìš°í„° + ì¼ë¶€ ë¡œì§ | âš ï¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í˜¼ì¬ (ê°œì„  ê¶Œì¥) |
| FileManager.php | íŒŒì¼ ì¡°ì‘ | âœ… ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬ |
| Auth.php | ì¸ì¦/ê¶Œí•œ | âœ… ì™„ì „í•œ ê¸°ëŠ¥ ì§‘ì¤‘ |
| Storage.php | ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ | âœ… ì˜ ë¶„ë¦¬ë¨ |
| JsonDB.php | ë°ì´í„° ì˜ì†ì„± | âœ… ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜ |
| app.js | UI/UX ì „ì²´ | âš ï¸ ë‹¨ì¼ íŒŒì¼ì— ëª¨ë“  ë¡œì§ (ë¶„ë¦¬ ê¶Œì¥) |

---

## ğŸ”’ 2. ë³´ì•ˆ ë¶„ì„

### 2.1 âœ… ì˜ êµ¬í˜„ëœ ë³´ì•ˆ ê¸°ëŠ¥

#### ê²½ë¡œ ì¡°ì‘ (Path Traversal) ë°©ì§€
```php
// FileManager.php - isPathSafe()
private function isPathSafe(string $basePath, string $targetPath): bool {
    $realBase = realpath($basePath);
    $realTarget = realpath($targetPath);
    // realpath()ë¡œ ì‹¤ì œ ê²½ë¡œ ë¹„êµ â†’ ../ ê³µê²© ì°¨ë‹¨
    return strpos($realTarget, $realBase) === 0;
}
```
**í‰ê°€**: âœ… `realpath()` ê¸°ë°˜ ê²€ì¦ìœ¼ë¡œ ì•ˆì „

#### íŒŒì¼ëª… ì •í™” (Sanitization)
```php
// FileManager.php - sanitizeFilename()
private function sanitizeFilename(string $filename): string {
    $filename = preg_replace('/[<>:"\/\\|?*\x00-\x1f]/', '', $filename);
    $filename = trim($filename, '. ');
    return $filename ?: 'unnamed';
}
```
**í‰ê°€**: âœ… ìœ„í—˜ ë¬¸ì í•„í„°ë§ ì–‘í˜¸

#### SQL ì¸ì ì…˜ ë°©ì§€ (FileIndex.php)
```php
$stmt = $this->db->prepare('INSERT INTO files ... VALUES (:storage_id, ...)');
$stmt->bindValue(':storage_id', $storageId, SQLITE3_INTEGER);
```
**í‰ê°€**: âœ… Prepared Statement ì „ë©´ ì‚¬ìš©

#### XSS ë°©ì§€
- **ë°±ì—”ë“œ**: `htmlspecialchars()` ì ì ˆíˆ ì‚¬ìš© (share.php, index.php)
- **í”„ë¡ íŠ¸ì—”ë“œ**: `escapeHtml()` í•¨ìˆ˜ë¡œ DOM ì‚½ì… ì‹œ ì´ìŠ¤ì¼€ì´í”„
```javascript
escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
```
**í‰ê°€**: âœ… ëŒ€ë¶€ë¶„ì˜ ì¶œë ¥ì—ì„œ ì ìš©ë¨

#### ì¸ì¦/ì„¸ì…˜ ë³´ì•ˆ
- ì„¸ì…˜ ê³ ì • ê³µê²© ë°©ì§€: `session_regenerate_id(true)`
- ë¸Œë£¨íŠ¸í¬ìŠ¤ ë°©ì§€: ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜ ì œí•œ (5íšŒ â†’ 15ë¶„ ì ê¸ˆ)
- ë¹„ë°€ë²ˆí˜¸: `password_hash(PASSWORD_DEFAULT)` ì‚¬ìš©
- Remember Me: ë³„ë„ í† í° ê¸°ë°˜ (ì„¸ì…˜ ID ë…¸ì¶œ ì•ˆ í•¨)
- IP/êµ­ê°€ ì œí•œ ê¸°ëŠ¥ ë‚´ì¥

#### ë³´ì•ˆ í—¤ë”
```php
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: SAMEORIGIN');
header('X-XSS-Protection: 1; mode=block');
header('Referrer-Policy: strict-origin-when-cross-origin');
```
**í‰ê°€**: âœ… ì£¼ìš” ë³´ì•ˆ í—¤ë” ëª¨ë‘ ì ìš©

#### CSRF ê³ ë ¤
- `session.cookie_samesite: Strict` ì„¤ì •
- ê°™ì€ ë„ë©”ì¸ Originë§Œ CORS í—ˆìš©

### 2.2 âš ï¸ ì£¼ì˜ê°€ í•„ìš”í•œ ë¶€ë¶„

#### 1) api.php í•´í‚¹ ê°ì§€ íŒ¨í„´ ê°œì„  ê¶Œì¥
```php
// í˜„ì¬ ì½”ë“œ (154-156ì¤„)
$suspiciousPatterns = ['../', '..\\', '<script', 'javascript:', 'onclick=', 'onerror='];
```
**ë¬¸ì œì **: 
- URL ì¸ì½”ë”©ëœ íŒ¨í„´ ë¯¸ê°ì§€ (`%2e%2e%2f`)
- ëŒ€ì†Œë¬¸ì ìš°íšŒ ê°€ëŠ¥ (`<SCRIPT>`)

**ê¶Œì¥ ìˆ˜ì •**:
```php
$inputString = urldecode(strtolower(json_encode($input)));
$suspiciousPatterns = ['../', '..\\', '<script', 'javascript:', 'onclick', 'onerror', 'onload'];
```

#### 2) ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª… ì¸ì½”ë”©
```php
// FileManager.php - download()
header('Content-Disposition: attachment; filename="' . $filename . '"');
```
**ë¬¸ì œì **: í•œê¸€/íŠ¹ìˆ˜ë¬¸ì íŒŒì¼ëª…ì´ ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ

**ê¶Œì¥ ìˆ˜ì •**:
```php
$encodedFilename = rawurlencode($filename);
header("Content-Disposition: attachment; filename=\"{$filename}\"; filename*=UTF-8''{$encodedFilename}");
```

#### 3) ì—…ë¡œë“œ MIME íƒ€ì… ê²€ì¦ ì—†ìŒ
í˜„ì¬ í™•ì¥ì ê¸°ë°˜ìœ¼ë¡œë§Œ íŒŒì¼ íƒ€ì… íŒë‹¨. ì•…ì„± íŒŒì¼ì´ í™•ì¥ì ìœ„ì¥ìœ¼ë¡œ ì—…ë¡œë“œë  ìˆ˜ ìˆìŒ.

**ê¶Œì¥ ì¶”ê°€**:
```php
$finfo = new finfo(FILEINFO_MIME_TYPE);
$realMime = $finfo->file($file['tmp_name']);
// $realMimeì™€ í™•ì¥ì ê¸°ë°˜ ì˜ˆìƒ MIME ë¹„êµ
```

#### 4) ë¡œê·¸ íŒŒì¼ ì ‘ê·¼ ë³´í˜¸
`/data/*.json` íŒŒì¼ë“¤ì´ ì›¹ì—ì„œ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•  ìˆ˜ ìˆìŒ.

**í™•ì¸ í•„ìš”**: `.htaccess`ë¡œ `/data/` í´ë” ì ‘ê·¼ ì°¨ë‹¨ ì„¤ì • í™•ì¸

---

## ğŸ”„ 3. ë°ì´í„° íë¦„ ë° ë™ê¸°í™”

### 3.1 ë°ì´í„° íë¦„ë„
```
[ë¸Œë¼ìš°ì € app.js]
      â†“ fetch API
[api.php ë¼ìš°í„°]
      â†“ action ë¶„ê¸°
[ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§] â† FileManager, Auth, ShareManager, Storage
      â†“
[ë°ì´í„° ê³„ì¸µ] â† JsonDB (JSON íŒŒì¼), FileIndex (SQLite)
      â†“
[íŒŒì¼ì‹œìŠ¤í…œ] â† ì‹¤ì œ íŒŒì¼ ì €ì¥ì†Œ
```

### 3.2 ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜
| ì˜ì—­ | ë°©ì‹ | ìƒíƒœ |
|------|------|------|
| JsonDB ë™ì‹œ ì“°ê¸° | íŒŒì¼ ë½í‚¹ (flock) | âœ… êµ¬í˜„ë¨ |
| FileIndex â†” ì‹¤ì œ íŒŒì¼ | auto_index ì˜µì…˜ | âœ… êµ¬í˜„ë¨ |
| ìŠ¤í† ë¦¬ì§€ used_size | ì—…ë¡œë“œ/ì‚­ì œ ì‹œ ê°±ì‹  | âœ… êµ¬í˜„ë¨ |
| ì„¸ì…˜ ë§Œë£Œ ì •ë¦¬ | ë¡œê·¸ì¸ ì‹œ ì •ë¦¬ | âœ… êµ¬í˜„ë¨ |

---

## ğŸ” 4. ë¬¸ì œ ê°€ëŠ¥ì„± ìˆëŠ” ë¶€ë¶„ ëª©ë¡

### 4.1 ğŸ”´ ì¦‰ì‹œ ìˆ˜ì • í•„ìš” (ìš°ì„ ìˆœìœ„ ë†’ìŒ)

| # | í•­ëª© | ìœ„ì¹˜ | ë¬¸ì œ | ê¶Œì¥ ì¡°ì¹˜ |
|---|------|------|------|-----------|
| 1 | MIME íƒ€ì… ë¯¸ê²€ì¦ | FileManager.php upload() | ì•…ì„± íŒŒì¼ ìœ„ì¥ ì—…ë¡œë“œ ê°€ëŠ¥ | finfoë¡œ ì‹¤ì œ íƒ€ì… ê²€ì¦ ì¶”ê°€ |
| 2 | í•´í‚¹ íŒ¨í„´ ìš°íšŒ ê°€ëŠ¥ | api.php 154-156ì¤„ | URL ì¸ì½”ë”©/ëŒ€ì†Œë¬¸ì ìš°íšŒ | urldecode + strtolower ì ìš© |
| 3 | ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª… ì¸ì½”ë”© | FileManager.php download() | í•œê¸€ íŒŒì¼ëª… ê¹¨ì§ | RFC 5987 í˜•ì‹ ì ìš© |

### 4.2 ğŸŸ¡ ë‚˜ì¤‘ì— ì •ë¦¬ ê°€ëŠ¥ (ìš°ì„ ìˆœìœ„ ì¤‘ê°„)

| # | í•­ëª© | ìœ„ì¹˜ | ë¬¸ì œ | ê¶Œì¥ ì¡°ì¹˜ |
|---|------|------|------|-----------|
| 4 | api.php ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í˜¼ì¬ | api.php ì „ì²´ | 2,300ì¤„ ë‹¨ì¼ íŒŒì¼ | ì•¡ì…˜ë³„ í´ë˜ìŠ¤ ë¶„ë¦¬ |
| 5 | app.js ë‹¨ì¼ íŒŒì¼ | assets/js/app.js | 7,300ì¤„ ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€ | ëª¨ë“ˆë³„ ë¶„ë¦¬ ë˜ëŠ” ë²ˆë“¤ëŸ¬ ë„ì… |
| 6 | StorageAdapter.php ë¯¸ì‚¬ìš© | api/StorageAdapter.php | 828ì¤„ ë¯¸ì‚¬ìš© ì½”ë“œ | ì‚­ì œ ë˜ëŠ” í™œìš© ê³„íš ëª…í™•í™” |
| 7 | DebugLog í•˜ë“œì½”ë”© | DebugLog.php | ë””ë²„ê·¸ íŒŒì¼ ê²½ë¡œ í•˜ë“œì½”ë”© | ì„¤ì •ìœ¼ë¡œ ë¶„ë¦¬ |

### 4.3 ğŸŸ¢ ê°œì„  ê¶Œì¥ ì‚¬í•­ (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)

| # | í•­ëª© | ë‚´ìš© |
|---|------|------|
| 8 | Rate Limiting | API ë ˆë²¨ ìš”ì²­ ì œí•œ ì¶”ê°€ ê¶Œì¥ |
| 9 | CSRF í† í° | ëª…ì‹œì  CSRF í† í° ë„ì… ê¶Œì¥ |
| 10 | íƒ€ì… íŒíŒ… | PHP 8.x íƒ€ì… ì„ ì–¸ í™•ëŒ€ |
| 11 | ì—ëŸ¬ ë¡œê¹… | êµ¬ì¡°í™”ëœ ì—ëŸ¬ ë¡œê¹… ì‹œìŠ¤í…œ |

---

## ğŸ“‹ 5. ì°¸ì¡°ë˜ì§€ë§Œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒŒì¼/í‚¤

ë¶„ì„ ê²°ê³¼ **ì¹˜ëª…ì ì¸ ëˆ„ë½ì€ ì—†ìŒ**. ë‹¤ë§Œ ì•„ë˜ ì‚¬í•­ í™•ì¸ í•„ìš”:

1. `config.php`ì—ì„œ `StorageAdapter.php` ë¡œë“œ ì£¼ì„ ì²˜ë¦¬ë¨ â†’ ì˜ë„ì  ë¹„í™œì„±í™” í™•ì¸
2. `.htaccess` íŒŒì¼ì´ `/data/` í´ë” ì ‘ê·¼ ì°¨ë‹¨í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”
3. `favicon.ico/png/svg` íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¼ ë™ì  ì²˜ë¦¬ë¨ (ì •ìƒ)

---

## ğŸ”§ 6. êµ¬ì¡°ì  í†µì¼ ê¶Œì¥ ì‚¬í•­

### 6.1 API ì‘ë‹µ í˜•ì‹ í†µì¼
í˜„ì¬ ëŒ€ë¶€ë¶„ ì¼ê´€ë˜ë‚˜ ì¼ë¶€ ì˜ˆì™¸ ìˆìŒ:
```php
// í‘œì¤€ í˜•ì‹ (ê¶Œì¥)
['success' => true, 'data' => [...]]
['success' => false, 'error' => 'ë©”ì‹œì§€']

// ì¼ë¶€ ì˜ˆì™¸ (í†µì¼ í•„ìš”)
['success' => true, ...ë°ì´í„°ë¥¼ ì§ì ‘ spread]
```

### 6.2 ê¶Œí•œ ì²´í¬ ë¡œì§ í†µì¼
```php
// í˜„ì¬: ì—¬ëŸ¬ ë°©ì‹ í˜¼ìš©
$auth->requireLogin();
$auth->requireAdmin();
$auth->requireRealAdmin();

// ê¶Œì¥: ëª…í™•í•œ ê³„ì¸µ êµ¬ì¡° ë¬¸ì„œí™”
// requireLogin() < requireAdmin() < requireRealAdmin()
```

### 6.3 ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ í†µì¼
```php
// í˜„ì¬: í˜¼ìš©
if (!$condition) return ['success' => false, 'error' => '...'];
if (!$condition) { http_response_code(403); exit('...'); }

// ê¶Œì¥: ì˜ˆì™¸ ê¸°ë°˜ í†µì¼ ë˜ëŠ” ëª…í™•í•œ ê¸°ì¤€ ìˆ˜ë¦½
```

---

## âš–ï¸ 7. ìµœì¢… ì•ˆì •ì„± íŒë‹¨

### ì¢…í•© í‰ê°€: **âœ… ì•ˆì • ìƒíƒœ (ì¡°ê±´ë¶€)**

| ì˜ì—­ | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| ê¸°ëŠ¥ ì™„ì„±ë„ | âœ… ì•ˆì • | í•µì‹¬ ê¸°ëŠ¥ ëª¨ë‘ ë™ì‘ |
| ë³´ì•ˆ ê¸°ë³¸ê¸° | âœ… ì–‘í˜¸ | ì£¼ìš” ì·¨ì•½ì  ë°©ì–´ë¨ |
| ì½”ë“œ í’ˆì§ˆ | âš ï¸ ë³´í†µ | ì‘ë™í•˜ë‚˜ ê°œì„  ì—¬ì§€ ìˆìŒ |
| ìœ ì§€ë³´ìˆ˜ì„± | âš ï¸ ë³´í†µ | ëŒ€í˜• ë‹¨ì¼ íŒŒì¼ ì¡´ì¬ |
| í™•ì¥ì„± | âš ï¸ ë³´í†µ | ëª¨ë“ˆí™” ê°œì„  ê¶Œì¥ |

### ê²°ë¡ 
> **í˜„ì¬ ìƒíƒœë¡œ ì‹¤ì‚¬ìš© ê°€ëŠ¥í•˜ë‚˜, ìœ„ "ì¦‰ì‹œ ìˆ˜ì • í•„ìš”" 3ê°œ í•­ëª©ì€ ë³´ì•ˆì„ ìœ„í•´ ì¡°ì¹˜ ê¶Œì¥.**
> ë‚˜ë¨¸ì§€ëŠ” ì ì§„ì  ë¦¬íŒ©í† ë§ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥.

---

## ğŸ“Š 8. ìˆ˜ì • ìš°ì„ ìˆœìœ„ ìš”ì•½

```
[ì¦‰ì‹œ ìˆ˜ì • - ë³´ì•ˆ ê°•í™”]
1. MIME íƒ€ì… ê²€ì¦ ì¶”ê°€       â±ï¸ 30ë¶„
2. í•´í‚¹ íŒ¨í„´ ê°ì§€ ê°•í™”       â±ï¸ 15ë¶„
3. ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª… ì¸ì½”ë”©     â±ï¸ 15ë¶„

[ë‹¨ê¸° - ì½”ë“œ í’ˆì§ˆ]
4. /data/ í´ë” ì ‘ê·¼ ì°¨ë‹¨ í™•ì¸ â±ï¸ 10ë¶„
5. ë””ë²„ê·¸ ë¡œê·¸ ì„¤ì • ë¶„ë¦¬      â±ï¸ 20ë¶„

[ì¤‘ì¥ê¸° - êµ¬ì¡° ê°œì„ ]
6. api.php ëª¨ë“ˆí™” ë¶„ë¦¬
7. app.js ëª¨ë“ˆí™” ë¶„ë¦¬
8. ë¯¸ì‚¬ìš© ì½”ë“œ ì •ë¦¬
```

---

*ë³´ê³ ì„œ ì‘ì„±: Claude | 2026-01-20*
